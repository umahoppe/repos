<!-- HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <h1>ğŸŒ¾ åœ°åŸŸãƒ»å¹´åˆ¥ æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ</h1>

    <form method="get">
        <label>æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼š</label>
        <select name="mode">
            <option value="monthly" {% if mode=='monthly' %}selected{% endif %}>æœˆã”ã¨æ¯”è¼ƒ</option>
            <option value="daily" {% if mode=='daily' %}selected{% endif %}>æ—¥ã”ã¨æ¯”è¼ƒ</option>
        </select>

        <label>åœ°åŸŸï¼š</label>
        <select name="location">
            {% for name in location_list %}
            <option value="{{ name }}" {% if location==name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>

        <label>æ¯”è¼ƒå¹´ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰ï¼š</label>
        <select name="years" multiple size="6">
            {% for y in valid_years %}
            <option value="{{ y }}" {% if y|string in selected_years %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>

        {% if mode == 'daily' %}
        <label>æ¯”è¼ƒæœˆï¼š</label>
        <select name="month">
            {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if m==selected_month %}selected{% endif %}>{{ m }}æœˆ</option>
            {% endfor %}
        </select>
        {% endif %}

        <button type="submit">è¡¨ç¤º</button>
    </form>



    {% if error %}
    <p class="error-message">{{ error }}</p>
    {% endif %}

    {% if labels %}
    <canvas id="tempChart" width="600" height="300"></canvas>
    <canvas id="rainChart" width="600" height="300"></canvas>


    <script>
        const labels = {{ labels | tojson}};
        const tempData = {{ temp_data | tojson}};
        const rainData = {{ rain_data | tojson}};
        const colorList = {{ colors | tojson}};

        // å¤‰æ›´å¾Œï¼ˆdatasetå´ã®è‰²ã‚’å„ªå…ˆï¼‰
        const coloredTempData = tempData.map((dataset, i) => {
            const bc = dataset.borderColor || colorList[i % colorList.length];
            const bg = dataset.backgroundColor || bc;
            return {
                ...dataset,
                borderColor: bc,
                backgroundColor: bg,
                borderWidth: dataset.borderWidth ?? 3,
                pointRadius: dataset.pointRadius ?? 3,
                tension: dataset.tension ?? 0.3,
                fill: dataset.fill ?? false
            };
        });

        const coloredRainData = rainData.map((dataset, i) => {
            const bc = dataset.borderColor || colorList[i % colorList.length];
            const bg = dataset.backgroundColor || bc;
            return {
                ...dataset,
                borderColor: bc,
                backgroundColor: bg,
                borderWidth: dataset.borderWidth ?? 1
            };
        });

        new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: { labels: labels, datasets: coloredTempData },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: '{{ location }} - {{ selected_month }}æœˆ ã® {{ "ã€æ—¥åˆ¥ã€‘" if mode == "daily" else "ã€æœˆåˆ¥ã€‘" }} å¹³å‡æ°—æ¸©ï¼ˆâ„ƒï¼‰',
                        font: { size: 20 },
                        padding: { top: 10, bottom: 10 }
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 14,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    },
                    y: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });


        new Chart(document.getElementById('rainChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: coloredRainData
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '{{ location }} - {{ selected_month }}æœˆ ã® {{ "ã€æ—¥åˆ¥ã€‘" if mode == "daily" else "ã€æœˆåˆ¥ã€‘" }} é™æ°´é‡åˆè¨ˆï¼ˆmmï¼‰',
                        font: { size: 20 },
                        padding: { top: 10, bottom: 10 }
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 14,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    },
                    y: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });    </script>



    {% endif %}
</body>

</html>
