<!-- HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <h1>ğŸŒ¾ åœ°åŸŸãƒ»å¹´åˆ¥ æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ</h1>

    <form method="get">
        <label>æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼š</label>
        <select name="mode">
            <option value="monthly" {% if mode=='monthly' %}selected{% endif %}>æœˆã”ã¨æ¯”è¼ƒ</option>
            <option value="daily" {% if mode=='daily' %}selected{% endif %}>æ—¥ã”ã¨æ¯”è¼ƒ</option>
        </select>

        <label>åœ°åŸŸï¼š</label>
        <select name="location">
            {% for name in location_list %}
            <option value="{{ name }}" {% if location==name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>

        <label>æ¯”è¼ƒå¹´ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰ï¼š</label>
        <select name="years" multiple size="6">
            {% for y in valid_years %}
            <option value="{{ y }}" {% if y|string in selected_years %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>

        {% if mode == 'daily' %}
        <label>æ¯”è¼ƒæœˆï¼š</label>
        <select name="month">
            {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if m==selected_month %}selected{% endif %}>{{ m }}æœˆ</option>
            {% endfor %}
        </select>
        {% endif %}

        <button type="submit">è¡¨ç¤º</button>
    </form>



    {% if error %}
    <p class="error-message">{{ error }}</p>
    {% endif %}

    {% if labels %}
    <div class="chart-tabs">
        <button class="tab-button active" data-type="temp">æ°—æ¸©</button>
        <button class="tab-button" data-type="rain">é™æ°´é‡</button>
        <button class="tab-button" data-type="hum">æ¹¿åº¦</button>
    </div>
    <canvas id="weatherChart" width="600" height="300"></canvas>

    <script>
        const labels = {{ labels | tojson}};
        const tempData = {{ temp_data | tojson}};
        const rainData = {{ rain_data | tojson}};
        const humData = {{ hum_data | tojson}};
        const colorList = {{ colors | tojson}};

        const colorize = (dataset, i, isLine = true) => {
            const color = colorList[i % colorList.length];
            return isLine
                ? {
                    ...dataset,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 3,
                    pointRadius: 3,
                    fill: false,
                    tension: 0.3
                }
                : {
                    ...dataset,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 1
                };
        };

        const coloredTempData = tempData.map((d, i) => colorize(d, i, true));
        const coloredRainData = rainData.map((d, i) => colorize(d, i, false));
        const coloredHumData = humData.map((d, i) => colorize(d, i, true));

        const baseTitle = '{{ location }}{{ " - " + (selected_month | string) + "æœˆ" if mode == "daily" else "" }} ã® {{ "ã€æ—¥åˆ¥ã€‘" if mode == "daily" else "ã€æœˆåˆ¥ã€‘" }}';

        const createOptions = (title) => ({
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: { size: 20 },
                    padding: { top: 10, bottom: 10 }
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        boxWidth: 14,
                        font: { size: 14 }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { font: { size: 14 } },
                    grid: { color: '#e0e0e0' }
                },
                y: {
                    ticks: { font: { size: 14 } },
                    grid: { color: '#e0e0e0' }
                }
            }
        });

        const ctx = document.getElementById('weatherChart');
        let currentChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: coloredTempData },
            options: createOptions(`${baseTitle} å¹³å‡æ°—æ¸©ï¼ˆâ„ƒï¼‰`)
        });

        function updateChart(type, datasets, title) {
            currentChart.destroy();
            currentChart = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: datasets },
                options: createOptions(title)
            });
        }

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const t = btn.dataset.type;
                if (t === 'temp') {
                    updateChart('line', coloredTempData, `${baseTitle} å¹³å‡æ°—æ¸©ï¼ˆâ„ƒï¼‰`);
                } else if (t === 'rain') {
                    updateChart('bar', coloredRainData, `${baseTitle} é™æ°´é‡åˆè¨ˆï¼ˆmmï¼‰`);
                } else if (t === 'hum') {
                    updateChart('line', coloredHumData, `${baseTitle} å¹³å‡ç›¸å¯¾æ¹¿åº¦ï¼ˆ%ï¼‰`);
                }
            });
        });
    </script>

    {% endif %}
</body>

</html>
