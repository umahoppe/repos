<!-- HTMLテンプレートのトップページ -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>気象データ比較</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <h1>🌾 地域・年別 気象データ比較</h1>

    <form method="get">
        <label>比較モード：</label>
        <select name="mode">
            <option value="monthly" {% if mode=='monthly' %}selected{% endif %}>月ごと比較</option>
            <option value="daily" {% if mode=='daily' %}selected{% endif %}>日ごと比較</option>
        </select>

        <label>地域：</label>
        <select name="location">
            {% for name in location_list %}
            <option value="{{ name }}" {% if location==name %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>

        <label>比較年（複数選択可）：</label>
        <select name="years" multiple size="6">
            {% for y in valid_years %}
            <option value="{{ y }}" {% if y|string in selected_years %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>

        {% if mode == 'daily' %}
        <label>比較月：</label>
        <select name="month">
            {% for m in range(1, 13) %}
            <option value="{{ m }}" {% if m==selected_month %}selected{% endif %}>{{ m }}月</option>
            {% endfor %}
        </select>
        {% endif %}

        <button type="submit">表示</button>
    </form>



    {% if error %}
    <p class="error-message">{{ error }}</p>
    {% endif %}

    {% if labels %}
    <canvas id="tempChart" width="600" height="300"></canvas>
    <canvas id="rainChart" width="600" height="300"></canvas>


    <script>
        const labels = {{ labels | tojson}};
        const tempData = {{ temp_data | tojson}};
        const rainData = {{ rain_data | tojson}};
        const colorList = {{ colors | tojson}};

        // 変更後（dataset側の色を優先）
        const coloredTempData = tempData.map((dataset, i) => {
            const bc = dataset.borderColor || colorList[i % colorList.length];
            const bg = dataset.backgroundColor || bc;
            return {
                ...dataset,
                borderColor: bc,
                backgroundColor: bg,
                borderWidth: dataset.borderWidth ?? 3,
                pointRadius: dataset.pointRadius ?? 3,
                tension: dataset.tension ?? 0.3,
                fill: dataset.fill ?? false
            };
        });

        const coloredRainData = rainData.map((dataset, i) => {
            const bc = dataset.borderColor || colorList[i % colorList.length];
            const bg = dataset.backgroundColor || bc;
            return {
                ...dataset,
                borderColor: bc,
                backgroundColor: bg,
                borderWidth: dataset.borderWidth ?? 1
            };
        });

        new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: { labels: labels, datasets: coloredTempData },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: '{{ location }} - {{ selected_month }}月 の {{ "【日別】" if mode == "daily" else "【月別】" }} 平均気温（℃）',
                        font: { size: 20 },
                        padding: { top: 10, bottom: 10 }
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 14,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    },
                    y: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });


        new Chart(document.getElementById('rainChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: coloredRainData
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '{{ location }} - {{ selected_month }}月 の {{ "【日別】" if mode == "daily" else "【月別】" }} 降水量合計（mm）',
                        font: { size: 20 },
                        padding: { top: 10, bottom: 10 }
                    },
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 14,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    },
                    y: {
                        ticks: { font: { size: 14 } },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });    </script>



    {% endif %}
</body>

</html>
